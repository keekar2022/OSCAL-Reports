# AWS Bedrock Integration

## Overview

The OSCAL Report Generator now supports **AWS Bedrock** as an AI provider for generating control implementation suggestions. This integration allows you to leverage Amazon's managed AI service with access to Mistral, Claude, Llama, and other models.

## What is AWS Bedrock?

AWS Bedrock is Amazon's fully managed service that offers foundation models from leading AI companies through a single API. It provides:

- **Managed Access**: No need to host or maintain AI infrastructure
- **Multiple Models**: Access to Mistral, Claude, Llama, and more
- **Enterprise Security**: AWS IAM-based access control and encryption
- **Scalability**: Pay-per-use pricing with automatic scaling
- **Compliance**: AWS compliance certifications and data residency options

## Supported Providers

The application now supports three AI provider options:

1. **Ollama** (Local/Self-hosted)
   - Self-hosted open-source AI
   - Full data privacy
   - No API costs
   - Requires dedicated infrastructure

2. **Mistral API** (Cloud)
   - Direct access to Mistral AI cloud service
   - Pay-per-use pricing
   - No infrastructure needed
   - Requires API key from console.mistral.ai

3. **AWS Bedrock** (Cloud - NEW!)
   - Managed AI service from Amazon
   - Multiple model options
   - Enterprise-grade security
   - AWS IAM-based access control

## AWS Bedrock Configuration

### Prerequisites

1. **AWS Account**: You need an active AWS account
2. **IAM User/Role**: Create an IAM user or role with Bedrock permissions
3. **Bedrock Access**: Ensure Bedrock is available in your selected region
4. **Model Access**: Request access to desired models in AWS Bedrock console

### Required IAM Permissions

Your AWS IAM user must have the following permission:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "bedrock:InvokeModel"
      ],
      "Resource": "*"
    }
  ]
}
```

### Setup Steps

1. **Navigate to AI Integration Settings**
   - Open the application
   - Go to **Settings** → **AI Integration**

2. **Select AWS Bedrock Provider**
   - Enable AI Integration
   - Select **AWS Bedrock** from the provider dropdown

3. **Configure AWS Credentials**
   - **AWS Region**: Select the region where Bedrock is available (e.g., `us-east-1`)
   - **AWS Access Key ID**: Your IAM access key
   - **AWS Secret Access Key**: Your IAM secret key
   - **Bedrock Model ID**: Select from available models

4. **Test Connection**
   - Click **Test Connection** to verify your credentials
   - The system will attempt a test API call to validate access

5. **Save Configuration**
   - Click **Save AI Configuration**
   - Your settings are securely stored in `config/app/config.json`

## Available Models

The following AWS Bedrock models are pre-configured:

### Mistral Models
- **Mistral Large** (`mistral.mistral-large-2402-v1:0`) - Recommended
  - Most capable Mistral model
  - Best for complex reasoning and long context
  
- **Mistral 7B Instruct** (`mistral.mistral-7b-instruct-v0:2`)
  - Smaller, faster model
  - Good for simple tasks
  
- **Mixtral 8x7B** (`mistral.mixtral-8x7b-instruct-v0:1`)
  - Mixture of experts model
  - Balance of speed and capability

### Anthropic Claude Models
- **Claude 3 Sonnet** (`anthropic.claude-3-sonnet-20240229-v1:0`)
  - High-quality general purpose model
  
- **Claude 3 Haiku** (`anthropic.claude-3-haiku-20240307-v1:0`)
  - Fastest Claude model
  - Cost-effective for high-volume tasks

### Meta Llama Models
- **Llama 3 70B** (`meta.llama3-70b-instruct-v1:0`)
  - Open-source large language model
  - Good for technical documentation

## Regional Availability

AWS Bedrock is available in the following regions:

- **US East (N. Virginia)** - `us-east-1` ⭐ Recommended
- **US West (Oregon)** - `us-west-2`
- **Europe (Ireland)** - `eu-west-1`
- **Europe (Frankfurt)** - `eu-central-1`
- **Asia Pacific (Singapore)** - `ap-southeast-1`
- **Asia Pacific (Tokyo)** - `ap-northeast-1`

**Note**: Model availability varies by region. Check the [AWS Bedrock documentation](https://docs.aws.amazon.com/bedrock/latest/userguide/models-regions.html) for the latest regional availability.

## Cost Considerations

AWS Bedrock pricing is based on:

- **Input Tokens**: Text sent to the model (prompts)
- **Output Tokens**: Text generated by the model (responses)

### Estimated Costs (as of Dec 2024)

For Mistral Large on AWS Bedrock (us-east-1):
- Input: ~$0.004 per 1,000 tokens
- Output: ~$0.012 per 1,000 tokens

**Example**: Generating 100 control implementations (~250 chars each):
- Estimated cost: **$0.15 - $0.30 USD**

**Note**: Pricing varies by model and region. Always check [AWS Bedrock Pricing](https://aws.amazon.com/bedrock/pricing/) for current rates.

## Security Best Practices

1. **IAM Credentials**
   - Use IAM users with minimal required permissions
   - Never share or commit access keys to version control
   - Rotate credentials regularly

2. **Least Privilege**
   - Grant only `bedrock:InvokeModel` permission
   - Consider using AWS STS temporary credentials
   - Use IAM roles for EC2/ECS deployments

3. **Data Privacy**
   - AWS Bedrock does not store or use your data for training
   - All prompts and responses are encrypted in transit (HTTPS/TLS)
   - Consider data residency requirements for compliance

4. **SSL/TLS Configuration**
   - **Development Mode**: SSL certificate verification is relaxed for easier testing
   - **Production Mode**: Full SSL certificate verification is enforced
   - **Corporate Networks**: May require additional proxy configuration
   - Set `NODE_ENV=production` for strict SSL verification in production deployments

5. **Monitoring**
   - Enable AWS CloudTrail for API call logging
   - Set up CloudWatch alerts for unusual usage
   - Monitor costs with AWS Cost Explorer

## Troubleshooting

### Common Issues

#### 1. "Unable to Get Local Issuer Certificate" Error
**Cause**: SSL certificate verification issue in Node.js environment

**Error Message**:
```
❌ Connection test failed
The pending stream has been canceled (caused by: unable to get local issuer certificate)
```

**Solution**:
This error has been **automatically fixed** in the latest version. The application now handles SSL certificates properly by:

- Using a custom HTTPS agent with proper certificate handling
- Disabling strict SSL verification in development mode
- Maintaining secure SSL in production mode

**Technical Details**:
The fix configures the AWS SDK with a custom `NodeHttpHandler` that includes:
```javascript
const httpsAgent = new HttpsAgent({
  rejectUnauthorized: process.env.NODE_ENV === 'production' ? true : false,
  keepAlive: true
});
```

**If you still encounter this issue**:
1. Ensure you're running the latest version (v1.2.6+)
2. Restart the backend server: `killall node && npm run dev`
3. Check if you're behind a corporate proxy that intercepts SSL traffic
4. Verify your system's Node.js installation is up to date

#### 2. "AWS Access Denied" Error
**Cause**: IAM credentials lack required permissions

**Solution**:
- Verify IAM user has `bedrock:InvokeModel` permission
- Check if credentials are correct (Access Key ID and Secret)
- Ensure Bedrock service is accessible (not restricted by SCP)

#### 3. "Model Not Found" Error
**Cause**: Selected model is not available in the region

**Solution**:
- Check model availability in your selected region
- Try a different region (e.g., us-east-1 has the most models)
- Request model access in AWS Bedrock console
- Ensure you've requested access to the model in the AWS Bedrock console (Model access page)

#### 4. "AWS Bedrock Throttling" Error
**Cause**: Rate limits exceeded

**Solution**:
- Reduce request frequency
- Request quota increase in AWS Service Quotas
- Consider using a different model with higher limits

#### 5. "AWS SDK Not Installed" Error
**Cause**: Backend dependencies not installed

**Solution**:
```bash
cd backend
npm install @aws-sdk/client-bedrock-runtime @smithy/node-http-handler
```

## Technical Implementation

### Backend Changes

1. **mistralService.js**
   - Added `generateWithAWSBedrock()` function
   - Integrated AWS SDK for JavaScript v3
   - Implemented AWS Bedrock Converse API
   - Added provider routing logic

2. **server.js**
   - Updated `/api/ai/test-connection` endpoint
   - Added AWS Bedrock connection testing
   - Implemented credential validation

### Frontend Changes

1. **AIIntegration.jsx**
   - Added provider selector dropdown
   - Implemented conditional form fields
   - Added AWS-specific configuration UI
   - Updated validation logic

2. **AIIntegration.css**
   - Maintained consistent styling
   - No CSS changes required (reused existing classes)

### Dependencies

New dependencies added:
```json
{
  "@aws-sdk/client-bedrock-runtime": "^3.x.x",
  "@smithy/node-http-handler": "^3.x.x"
}
```

**Note**: `@smithy/node-http-handler` is used for custom SSL certificate handling and is required for proper HTTPS communication with AWS Bedrock.

## API Reference

### AWS Bedrock Converse API

The integration uses the AWS Bedrock Converse API for uniform model interaction:

```javascript
const command = new ConverseCommand({
  modelId: 'mistral.mistral-large-2402-v1:0',
  messages: [
    {
      role: 'user',
      content: [{ text: prompt }]
    }
  ],
  inferenceConfig: {
    maxTokens: 512,
    temperature: 0.7,
    topP: 0.9
  }
});

const response = await client.send(command);
```

### Configuration Storage

AWS Bedrock configuration is stored in `config/app/config.json`:

```json
{
  "aiConfig": {
    "enabled": true,
    "provider": "aws-bedrock",
    "awsRegion": "us-east-1",
    "awsAccessKeyId": "AKIAIOSFODNN7EXAMPLE",
    "awsSecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
    "bedrockModelId": "mistral.mistral-large-2402-v1:0",
    "timeout": 180000,
    "organizationName": "Your Company"
  }
}
```

**Security Note**: Credentials are stored in the configuration file. Ensure proper file permissions and consider using environment variables for production deployments.

## Documentation References

- [AWS Bedrock Documentation](https://docs.aws.amazon.com/bedrock/)
- [Bedrock Converse API](https://docs.aws.amazon.com/bedrock/latest/userguide/bedrock-runtime_example_bedrock-runtime_Converse_Mistral_section.html)
- [Bedrock Models](https://docs.aws.amazon.com/bedrock/latest/userguide/models-supported.html)
- [AWS SDK for JavaScript v3](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/)

## Version History

- **v1.2.6** (Dec 2024)
  - Added AWS Bedrock provider support
  - Implemented multi-provider architecture
  - Added Bedrock-specific UI configuration
  - Updated backend to support AWS SDK

## Support

For issues or questions:
1. Check the **Troubleshooting** section above
2. Review AWS Bedrock console for service health
3. Check CloudWatch logs for detailed error messages
4. Verify IAM permissions and credentials

---

**Last Updated**: December 16, 2024  
**Version**: 1.2.6  
**Author**: Mukesh Kesharwani

